<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="challengeRepository">

    <!-- ì „ì²´ ì±Œë¦°ì§€ ëª©ë¡ ì¡°íšŒ (í•„í„°ë§ ì—†ìŒ) -->
    <select id="findAllChallenges" resultType="challenge">
        SELECT * FROM Challenges ORDER BY challenge_id DESC
    </select>

    <!-- ðŸŽ¯ íŠ¹ì • ì–¸ì–´ì˜ ì±Œë¦°ì§€ ëª©ë¡ ì¡°íšŒ -->
    <select id="findChallengesByLanguage" resultType="challenge">
        SELECT * FROM Challenges WHERE language = #{language} ORDER BY challenge_id DESC
    </select>

    <!-- íŠ¹ì • ì±Œë¦°ì§€ ìƒì„¸ ì¡°íšŒ -->
    <select id="findChallengeById" resultType="challenge">
        SELECT * FROM Challenges WHERE challenge_id = #{challengeId}
    </select>

    <!-- ì „ì²´ ë‚œì´ë„ ëª©ë¡ ì¡°íšŒ -->
    <select id="findAllLevels" resultType="challengeLevel">
        SELECT * FROM Challenge_Levels ORDER BY exp
    </select>

    <!-- ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ -->
    <select id="findAllCategories" resultType="challengeCategory">
        SELECT * FROM Challenge_Categorys ORDER BY category_id
    </select>

    <!-- íŠ¹ì • ë‚œì´ë„ ì¡°íšŒ (ì´ë¦„ìœ¼ë¡œ) -->
    <select id="findLevelByName" resultType="challengeLevel">
        SELECT * FROM Challenge_Levels WHERE level_name = #{levelName}
    </select>

    <!-- íŠ¹ì • ë‚œì´ë„ ì¡°íšŒ (IDë¡œ) -->
    <select id="findLevelById" resultType="challengeLevel">
        SELECT * FROM Challenge_Levels WHERE level_id = #{levelId}
    </select>

    <!-- íŠ¹ì • ì¹´í…Œê³ ë¦¬ ì¡°íšŒ (ì´ë¦„ìœ¼ë¡œ) -->
    <select id="findCategoryByName" resultType="challengeCategory">
        SELECT * FROM Challenge_Categorys WHERE category_name = #{categoryName}
    </select>

    <!-- íŠ¹ì • ì¹´í…Œê³ ë¦¬ ì¡°íšŒ (IDë¡œ) -->
    <select id="findCategoryById" resultType="challengeCategory">
        SELECT * FROM Challenge_Categorys WHERE category_id = #{categoryId}
    </select>

    <!-- ì±Œë¦°ì§€ ì™„ë£Œìž ìˆ˜ ì¡°íšŒ -->
    <select id="getCompletedCount" resultType="int">
        SELECT COUNT(*) FROM Challenge_sub WHERE challenge_id = #{challengeId}
    </select>

    <!-- ì „ì²´ ì±Œë¦°ì§€ ìˆ˜ ì¡°íšŒ -->
    <select id="getTotalChallengeCount" resultType="int">
        SELECT COUNT(*) FROM Challenges
    </select>

    <!-- ðŸŽ¯ íŠ¹ì • ì±Œë¦°ì§€ì˜ í†µê³„ ì •ë³´ ì¡°íšŒ (ì œì¶œìˆ˜, ì •ë‹µìˆ˜, ì •ë‹µë¥ ) -->
    <select id="getChallengeStatistics" resultType="map">
        SELECT 
            COUNT(*) as totalSubmissions,
            SUM(CASE WHEN pass = true THEN 1 ELSE 0 END) as correctSubmissions,
            CASE 
                WHEN COUNT(*) > 0 THEN 
                    ROUND((SUM(CASE WHEN pass = true THEN 1 ELSE 0 END) * 100.0 / COUNT(*)), 1)
                ELSE 0.0 
            END as accuracyRate
        FROM Challenge_sub 
        WHERE challenge_id = #{challengeId}
    </select>

    <!-- ðŸŽ¯ ìƒˆë¡œìš´ ì±Œë¦°ì§€ ë“±ë¡ -->
    <insert id="insertChallenge" parameterType="challenge">
        INSERT INTO Challenges (
            challenge_title,
            level_id,
            category_id,
            language,
            content,
            hint,
            correct
        ) VALUES (
            #{challenge_title},
            #{level_id},
            #{category_id},
            #{language},
            #{content},
            #{hint},
            #{correct}
        )
    </insert>

    <!-- ðŸŽ¯ ë°ì´í„°ë² ì´ìŠ¤ì— ë“±ë¡ëœ ëª¨ë“  ì–¸ì–´ ëª©ë¡ ì¡°íšŒ -->
    <select id="findAllLanguages" resultType="string">
        SELECT DISTINCT language FROM Challenges 
        WHERE language IS NOT NULL AND language != '' 
        ORDER BY language
    </select>

    <!-- ðŸŽ¯ ì±Œë¦°ì§€ ì‚­ì œ -->
    <delete id="deleteChallenge" parameterType="int">
        DELETE FROM Challenges WHERE challenge_id = #{challengeId}
    </delete>

</mapper>